const _0x12bb31=_0x1a6a;(function(_0x30cb06,_0x1746bd){const _0x208089=_0x1a6a,_0xe04445=_0x30cb06();while(!![]){try{const _0x730b1b=-parseInt(_0x208089(0x99))/0x1+parseInt(_0x208089(0x94))/0x2*(-parseInt(_0x208089(0xc2))/0x3)+parseInt(_0x208089(0xb4))/0x4+-parseInt(_0x208089(0xa6))/0x5*(parseInt(_0x208089(0x9e))/0x6)+-parseInt(_0x208089(0xc4))/0x7*(-parseInt(_0x208089(0xb0))/0x8)+-parseInt(_0x208089(0xca))/0x9+parseInt(_0x208089(0xba))/0xa*(parseInt(_0x208089(0xd1))/0xb);if(_0x730b1b===_0x1746bd)break;else _0xe04445['push'](_0xe04445['shift']());}catch(_0x22d3fd){_0xe04445['push'](_0xe04445['shift']());}}}(_0x359a,0x7a196));const asyncHandler=require(_0x12bb31(0x89)),Invoice=require(_0x12bb31(0xb6)),Commission=require(_0x12bb31(0xb9)),Agent=require(_0x12bb31(0xb3)),Store=require(_0x12bb31(0xc0)),Customer=require(_0x12bb31(0x8d)),{handleGeneratePDF}=require('../middlewares/helpers/generatePdf'),mongoose=require(_0x12bb31(0xbe)),{MyCustomError}=require('../middlewares/error/error.handler'),{uploadToS3,getPresignedUrl,deleteS3Object}=require(_0x12bb31(0xa0)),createInvoice=asyncHandler(async(_0x23fca4,_0x83e37e,_0x579424)=>{const _0x3beab0=_0x12bb31,_0x573f63=await mongoose[_0x3beab0(0xa9)]();try{_0x573f63['startTransaction']();const {customer:_0x1c2310,agent:_0x43ac75,products:_0x7dca7b,totalAmount:_0x46a574,issueDate:_0x542957}=_0x23fca4[_0x3beab0(0xa4)];if(!_0x7dca7b||_0x7dca7b[_0x3beab0(0xa8)]===0x0)return await _0x573f63['abortTransaction'](),new MyCustomError(0x190,_0x3beab0(0xcb));if(!mongoose[_0x3beab0(0xab)](_0x43ac75)||!await Agent['exists']({'_id':_0x43ac75}))return await _0x573f63[_0x3beab0(0xcd)](),_0x579424(new MyCustomError(0x194,'Agent\x20Not\x20found'));isValidObjectId=mongoose[_0x3beab0(0x95)]['ObjectId'][_0x3beab0(0xd2)](_0x1c2310);if(!mongoose[_0x3beab0(0xab)](_0x1c2310)||!await Customer['exists']({'_id':_0x1c2310}))return await _0x573f63[_0x3beab0(0xcd)](),_0x579424(new MyCustomError(0x194,_0x3beab0(0x9a)));const _0x3248ad=new Invoice({'store':_0x23fca4[_0x3beab0(0x8f)][_0x3beab0(0xa2)],'agent':_0x43ac75,'customer':_0x1c2310,'products':_0x7dca7b,'totalAmount':_0x46a574,'issueDate':_0x542957}),_0x551680=await _0x3248ad[_0x3beab0(0xc7)]({'session':_0x573f63});if(!_0x551680[_0x3beab0(0xc3)])return await _0x573f63['abortTransaction'](),_0x579424(new MyCustomError(0x1f4,_0x3beab0(0xbf)));const _0x1f544c=new Commission({'invoiceNum':_0x551680['invoiceUid'],'agent':_0x43ac75,'store':_0x23fca4[_0x3beab0(0x8f)]['_id'],'customer':_0x1c2310,'amount':_0x46a574,'issueDate':_0x542957,'agentCommission':_0x46a574*_0x23fca4[_0x3beab0(0x8f)][_0x3beab0(0xbb)]/0x64,'totalCommission':_0x46a574*_0x23fca4[_0x3beab0(0x8f)][_0x3beab0(0xc9)]/0x64});await _0x1f544c[_0x3beab0(0xc7)]({'session':_0x573f63});const _0x295946=await _0x551680[_0x3beab0(0xac)](['store','products.product','customer']),_0x2450f4=handleGeneratePDF({'items':_0x295946[_0x3beab0(0xb8)],'customer':_0x295946[_0x3beab0(0x9b)],'store':_0x295946[_0x3beab0(0xcf)],'invoiceUid':_0x295946[_0x3beab0(0xc3)]}),_0x55fc85=await uploadToS3({'file':_0x2450f4,'uid':_0x295946[_0x3beab0(0xcf)]['storeUid'],'user':'store','type':_0x3beab0(0x88)});_0x551680['invoiceDoc']=_0x55fc85,await _0x551680[_0x3beab0(0xc7)]({'session':_0x573f63}),await _0x573f63['commitTransaction']();const _0x4fa53e=await getPresignedUrl(_0x55fc85[_0x3beab0(0x98)]);_0x83e37e['status'](0xc9)['json'](_0x4fa53e);}catch(_0x3b44e6){await _0x573f63[_0x3beab0(0xcd)](),_0x579424(_0x3b44e6);}finally{await _0x573f63['endSession']();}}),getAllInvoice=asyncHandler(async(_0x49ce5b,_0x196cd6,_0x4373b7)=>{const _0x5e0b32=_0x12bb31;try{const {sortType:_0x285b17,asc:asc='true',page:page=0x1,limit:limit=0xa,search:search='',agentSearch:agentSearch='',customerSearch:customerSearch='',storeSearch:storeSearch=''}=_0x49ce5b[_0x5e0b32(0x97)];let _0x3e1bec={};if(_0x285b17)_0x3e1bec[_0x285b17]=asc==='true'?0x1:-0x1,_0x285b17!==_0x5e0b32(0xb1)&&(_0x3e1bec={..._0x3e1bec,'pendingCommission':-0x1});else _0x3e1bec[_0x5e0b32(0xb1)]=-0x1;const _0x37270f=_0x49ce5b[_0x5e0b32(0x97)][_0x5e0b32(0x8b)]?new Date(_0x49ce5b[_0x5e0b32(0x97)][_0x5e0b32(0x8b)]+'T00:00:00.000+05:30'):new Date(_0x5e0b32(0xaf)),_0x13dc34=_0x49ce5b[_0x5e0b32(0x97)][_0x5e0b32(0xa7)]?new Date(_0x49ce5b['query'][_0x5e0b32(0xa7)]+'T23:59:59.999+05:30'):new Date(),_0xabbdd2=[_0x49ce5b[_0x5e0b32(0x8f)][_0x5e0b32(0xa3)]===_0x5e0b32(0xcf)&&{'$match':{'store':_0x49ce5b[_0x5e0b32(0x8f)]['_id']}},_0x49ce5b['user'][_0x5e0b32(0xa3)]===_0x5e0b32(0xbd)&&{'$match':{'agent':_0x49ce5b[_0x5e0b32(0x8f)]['_id']}},{'$match':{'invoiceNum':{'$regex':search,'$options':'i'},'issueDate':{'$gte':_0x37270f,'$lt':_0x13dc34}}},_0x49ce5b[_0x5e0b32(0x8f)]['role']!==_0x5e0b32(0xcf)&&{'$lookup':{'from':_0x5e0b32(0xd0),'localField':_0x5e0b32(0xcf),'foreignField':_0x5e0b32(0xa2),'as':_0x5e0b32(0xcf),'pipeline':[{'$project':{'storeName':0x1,'deleteStatus':0x1,'storeUid':0x1}}]}},_0x49ce5b[_0x5e0b32(0x8f)]['role']!==_0x5e0b32(0xcf)&&{'$unwind':_0x5e0b32(0xc5)},_0x49ce5b[_0x5e0b32(0x8f)][_0x5e0b32(0xa3)]!==_0x5e0b32(0xbd)&&{'$lookup':{'from':'agents','localField':_0x5e0b32(0xbd),'foreignField':_0x5e0b32(0xa2),'as':_0x5e0b32(0xbd),'pipeline':[{'$project':{'name':0x1,'deleteStatus':0x1,'agentUid':0x1}}]}},_0x49ce5b[_0x5e0b32(0x8f)][_0x5e0b32(0xa3)]!==_0x5e0b32(0xbd)&&{'$unwind':_0x5e0b32(0x8e)},{'$lookup':{'from':_0x5e0b32(0x9f),'localField':_0x5e0b32(0x9b),'foreignField':_0x5e0b32(0xa2),'as':_0x5e0b32(0x9b),'pipeline':[{'$project':{'name':0x1,'deleteStatus':0x1,'customerUid':0x1}}]}},{'$unwind':_0x5e0b32(0x9d)},_0x49ce5b['user'][_0x5e0b32(0xa3)]===_0x5e0b32(0x90)&&{'$match':{'$and':[{'store.storeName':{'$regex':storeSearch,'$options':'i'}},{'agent.name':{'$regex':agentSearch,'$options':'i'}},{'customer.name':{'$regex':customerSearch,'$options':'i'}}]}},_0x49ce5b[_0x5e0b32(0x8f)][_0x5e0b32(0xa3)]==='agent'&&{'$match':{'$and':[{'store.storeName':{'$regex':storeSearch,'$options':'i'}},{'customer.name':{'$regex':customerSearch,'$options':'i'}}]}},_0x49ce5b[_0x5e0b32(0x8f)]['role']===_0x5e0b32(0xcf)&&{'$match':{'$and':[{'agent.name':{'$regex':agentSearch,'$options':'i'}},{'customer.name':{'$regex':customerSearch,'$options':'i'}}]}},_0x49ce5b[_0x5e0b32(0x8f)][_0x5e0b32(0xa3)]!=='agent'&&{'$lookup':{'from':_0x5e0b32(0xbc),'localField':_0x5e0b32(0xcc),'foreignField':_0x5e0b32(0xc3),'as':_0x5e0b32(0xb5),'pipeline':[{'$project':{'invoiceDoc':0x1}}]}},_0x49ce5b['user'][_0x5e0b32(0xa3)]!==_0x5e0b32(0xbd)&&{'$unwind':{'path':_0x5e0b32(0x96),'preserveNullAndEmptyArrays':!![]}},{'$sort':{..._0x3e1bec,'_id':-0x1}},{'$facet':{'documentCount':[{'$count':_0x5e0b32(0x92)}],'invoiceList':[{'$skip':(+page-0x1)*+limit},{'$limit':+limit}]}},{'$project':{'invoiceList':0x1,'documentCount':{'$arrayElemAt':[_0x5e0b32(0xc8),0x0]}}}],_0xccfeb0=await Commission[_0x5e0b32(0x87)](_0xabbdd2[_0x5e0b32(0xad)](_0x505721=>!!_0x505721))['collation']({'locale':'en_US','numericOrdering':!![]}),_0x3a89d3=await Promise[_0x5e0b32(0x93)](_0xccfeb0[0x0]?.[_0x5e0b32(0xa5)]?.[_0x5e0b32(0x8c)](async _0x3cfadb=>{const _0x28ef3a=_0x5e0b32;if(_0x3cfadb?.['invoiceInfo']?.[_0x28ef3a(0xaa)]?.[_0x28ef3a(0x98)]){const _0x5a4364=await getPresignedUrl(_0x3cfadb[_0x28ef3a(0xb5)]['invoiceDoc'][_0x28ef3a(0x98)]);_0x3cfadb[_0x28ef3a(0xb5)]=_0x5a4364;}return _0x3cfadb;}));_0x196cd6['status'](0xc8)[_0x5e0b32(0xc1)]({'invoiceList':_0x3a89d3,'documentCount':_0xccfeb0[0x0]?.[_0x5e0b32(0xce)]||0x0,'page':parseInt(page),'limit':parseInt(limit),'order':asc===_0x5e0b32(0xa1)?_0x5e0b32(0x8a):'desc','sortType':_0x285b17||_0x5e0b32(0xb1)});}catch(_0x6561e8){_0x4373b7(_0x6561e8);}}),deleteInvoice=asyncHandler(async(_0x121575,_0x5a2d99,_0x33c4db)=>{const _0x3dc816=_0x12bb31,{id:_0x904157}=_0x121575['params'],_0x209270=await mongoose[_0x3dc816(0xa9)]();try{_0x209270['startTransaction']();const _0x58f405=await Invoice[_0x3dc816(0x9c)]({'invoiceUid':_0x904157},{'session':_0x209270}),_0x2cc978=await Commission['findOneAndDelete']({'invoiceNum':_0x904157},{'session':_0x209270});if(_0x58f405)deleteS3Object(_0x58f405?.[_0x3dc816(0xaa)]?.[_0x3dc816(0x98)]);await _0x209270[_0x3dc816(0x91)](),_0x5a2d99[_0x3dc816(0xc1)]({'commission':_0x2cc978,'invoice':_0x58f405});}catch(_0x1a4e6e){await _0x209270[_0x3dc816(0xcd)](),_0x33c4db(_0x1a4e6e);}finally{await _0x209270[_0x3dc816(0xb7)]();}}),getOneCustomer=asyncHandler(async(_0x9d039a,_0x619b23,_0xf1ad45)=>{const _0x3ab36c=_0x12bb31,{id:_0x5728b3}=_0x9d039a[_0x3ab36c(0xae)];try{const _0xdf7a=await Customer['findOne']({'phoneNumber':_0x5728b3})['populate']({'path':_0x3ab36c(0xbd),'select':_0x3ab36c(0xc6)});if(!_0xdf7a)return _0xf1ad45(new MyCustomError(0x194,'Customer\x20not\x20found.'));_0x619b23[_0x3ab36c(0xb2)](0xc8)[_0x3ab36c(0xc1)]({'customer':_0xdf7a});}catch(_0x206b51){_0xf1ad45(_0x206b51);}});function _0x1a6a(_0x58c23c,_0x5df26c){const _0x359a3f=_0x359a();return _0x1a6a=function(_0x1a6a7d,_0x71764a){_0x1a6a7d=_0x1a6a7d-0x87;let _0x3cc203=_0x359a3f[_0x1a6a7d];return _0x3cc203;},_0x1a6a(_0x58c23c,_0x5df26c);}function _0x359a(){const _0xb4d309=['../models/customer.model','$agent','user','admin','commitTransaction','total','all','758qZhuSt','Types','$invoiceInfo','query','key','897449mLfGOP','Customer\x20doesnot\x20exists','customer','findOneAndDelete','$customer','2814354jckfmm','customers','../aws/s3','true','_id','role','body','invoiceList','10EsLsdJ','endDate','length','startSession','invoiceDoc','isValidObjectId','populate','filter','params','1970-01-01','40TFqMQK','issueDate','status','../models/agent.model','2019904thBWIT','invoiceInfo','../models/invoice.model','endSession','products','../models/commission.model','12790Ppgzij','agentPercentage','invoices','agent','mongoose','Oops!\x20somenthing\x20went\x20wrong\x20!!!','../models/store.model','json','1047BUMIjZ','invoiceUid','1113539HLUKFo','$store','name\x20phoneNumber','save','$documentCount.total','lifeStorePercentage','8956746MfNVNC','add\x20atleast\x20one\x20product','invoiceNum','abortTransaction','documentCount','store','stores','18601pMijZz','isValid','aggregate','invoice','express-async-handler','asc','startDate','map'];_0x359a=function(){return _0xb4d309;};return _0x359a();}module['exports']={'createInvoice':createInvoice,'getAllInvoice':getAllInvoice,'deleteInvoice':deleteInvoice,'getOneCustomer':getOneCustomer};