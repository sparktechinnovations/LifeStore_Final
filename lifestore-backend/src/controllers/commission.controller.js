function _0x1377(_0x477f02,_0x260e28){const _0x4299eb=_0x4299();return _0x1377=function(_0x137789,_0x3bdc78){_0x137789=_0x137789-0x18b;let _0x12cb95=_0x4299eb[_0x137789];return _0x12cb95;},_0x1377(_0x477f02,_0x260e28);}function _0x4299(){const _0x225385=['$agentInfo.name','9015048bhJXyH','storeList','Problem\x20with\x20finding\x20the\x20store\x20please\x20contact\x20support','startDate','totalAmount','Customer\x20doesnot\x20exists','save','14260EIdhqq','376MiaKzY','T00:00:00.000Z','$pendingCommission','paymentList','total','stores','T23:59:59.999+05:30','T00:00:00.000+05:30','endDate','remarks','length','toISOString','Problem\x20with\x20Finding\x20the\x20Store\x20Please\x20Contact\x20Support','insufficient\x20premission\x20to\x20view\x20this\x20store','No\x20pending\x20Amount','Types','Something\x20went\x20wrong,\x20contact\x20support\x20if\x20perists','pendingCommission','$agentCommission','$documentCount.total','exports','toFixed','%Y-%m-%d','internal\x20server\x20error','mongoose','956thNlsm','toString','244601xRmPCM','$agent.name','store','all','agentInfo','_id','1124794WAqXtV','abortTransaction','isValid','$totalCommission.totalCommission','agentPayment','Amount\x20is\x20required','3687498IAdPVv','getTime','params','agentpayments','user','desc','Date\x20is\x20required','findById','$agentPaymentInfo.date','date','Pelase\x20Enter\x20payment\x20date','Access\x20denied.\x20Insufficient\x20permissions.','documentCount','endSession','1970-01-01','status','agentPaymentUid','UTC','$storePayment','$totalCommission','startTransaction','isValidObjectId','storepayments','storePayment','storePaymentUid','agentPaymentInfo','filter','updateMany','../models/commission.model','1151864sNkcAN','true','$store.storeName','$storePaymentInfo','totalCommission','commitTransaction','Agent\x20Not\x20found','agent','en_US','role','json','startSession','admin','exists','T23:59:59.999Z','../models/agentPayment.model','query','Problem\x20with\x20Finding\x20the\x20Agent\x20Please\x20Contact\x20Support','$adjustedCreatedAt','$store','$agentPayment','$latestAgentPaymentDate','credit','$createdAt','Invoice\x20already\x20exists,\x20please\x20contact\x20support\x20if\x20you\x20want\x20to\x20update\x20the\x20entry','Please\x20Enter\x20End\x20Date','storeInfo','2973555IKLWGH','collation','../models/storePayment.model','$storeInfo','asc','amount','aggregate','ObjectId'];_0x4299=function(){return _0x225385;};return _0x4299();}const _0x1c1b55=_0x1377;(function(_0x593577,_0x21c996){const _0xa1e8c3=_0x1377,_0x43cecf=_0x593577();while(!![]){try{const _0x5c830e=-parseInt(_0xa1e8c3(0x18e))/0x1+parseInt(_0xa1e8c3(0x1b1))/0x2+parseInt(_0xa1e8c3(0x1cc))/0x3+-parseInt(_0xa1e8c3(0x1f6))/0x4*(-parseInt(_0xa1e8c3(0x1dc))/0x5)+-parseInt(_0xa1e8c3(0x1d5))/0x6+parseInt(_0xa1e8c3(0x1f8))/0x7*(parseInt(_0xa1e8c3(0x1dd))/0x8)+-parseInt(_0xa1e8c3(0x194))/0x9;if(_0x5c830e===_0x21c996)break;else _0x43cecf['push'](_0x43cecf['shift']());}catch(_0x3a8569){_0x43cecf['push'](_0x43cecf['shift']());}}}(_0x4299,0xd081a));const asyncHandler=require('express-async-handler'),Commission=require(_0x1c1b55(0x1b0)),mongoose=require(_0x1c1b55(0x1f5)),{MyCustomError}=require('../middlewares/error/error.handler'),Agent=require('../models/agent.model'),Store=require('../models/store.model'),Customer=require('../models/customer.model'),AgentPayment=require(_0x1c1b55(0x1c0)),StorePayment=require(_0x1c1b55(0x1ce)),createCommission=asyncHandler(async(_0x1038cc,_0x5f13b4,_0xc8368b)=>{const _0x2471b9=_0x1c1b55;try{const {invoiceNum:_0x4eae7f,agent:_0x6461e9,customer:_0x5278e2,amount:_0x37fed4}=_0x1038cc['body'];if(await Commission['exists']({'store':_0x1038cc['user'][_0x2471b9(0x18d)],'invoiceNum':_0x4eae7f}))return _0xc8368b(new MyCustomError(0x194,_0x2471b9(0x1c9)));if(!mongoose[_0x2471b9(0x1a9)](_0x6461e9)||!await Agent[_0x2471b9(0x1be)]({'_id':_0x6461e9}))return _0xc8368b(new MyCustomError(0x194,_0x2471b9(0x1b7)));isValidObjectId=mongoose[_0x2471b9(0x1ec)][_0x2471b9(0x1d3)][_0x2471b9(0x190)](_0x5278e2);if(!mongoose[_0x2471b9(0x1a9)](_0x5278e2)||!await Customer['exists']({'_id':_0x5278e2}))return _0xc8368b(new MyCustomError(0x194,_0x2471b9(0x1da)));const _0x16494a=new Commission({'invoiceNum':_0x4eae7f,'agent':_0x6461e9,'store':_0x1038cc['user']['_id'],'customer':_0x5278e2,'amount':_0x37fed4,'agentCommission':_0x37fed4*_0x1038cc[_0x2471b9(0x198)]['agentPercentage']/0x64,'totalCommission':_0x37fed4*_0x1038cc[_0x2471b9(0x198)]['lifeStorePercentage']/0x64});await _0x16494a[_0x2471b9(0x1db)](),_0x5f13b4[_0x2471b9(0x1a3)](0xc9)[_0x2471b9(0x1bb)](_0x16494a);}catch(_0x19307e){_0xc8368b(_0x19307e);}}),getAllStoreCommission=asyncHandler(async(_0xf2da2b,_0x4740e9,_0x7da21a)=>{const _0x503857=_0x1c1b55;try{const {sortType:_0x541485,asc:asc=_0x503857(0x1b2),page:page=0x1,limit:limit=0xa,search:search=''}=_0xf2da2b['query'];let _0x150321={};if(_0x541485)_0x150321[_0x541485]=asc===_0x503857(0x1b2)?0x1:-0x1,_0x541485!=='pendingCommission'&&(_0x150321={..._0x150321,'pendingCommission':-0x1});else _0x150321[_0x503857(0x1ee)]=-0x1;const _0x5023f1=_0xf2da2b[_0x503857(0x1c1)][_0x503857(0x1d8)]?new Date(_0xf2da2b[_0x503857(0x1c1)][_0x503857(0x1d8)]+_0x503857(0x1de)):new Date(_0x503857(0x1a2)),_0x7ec7a8=_0xf2da2b[_0x503857(0x1c1)][_0x503857(0x1e5)]?new Date(_0xf2da2b[_0x503857(0x1c1)][_0x503857(0x1e5)]+_0x503857(0x1bf)):new Date(new Date()[_0x503857(0x195)]()+0x14a*0x3c*0x3e8),_0x6843ed=[{'$lookup':{'from':_0x503857(0x1e2),'localField':_0x503857(0x1fa),'foreignField':_0x503857(0x18d),'as':'storeInfo','pipeline':[{'$project':{'profilePic':0x1,'storeName':0x1,'deleteStatus':0x1,'credit':0x1,'lifeStorePercentage':0x1,'storeUid':0x1,'phoneNumber':0x1,'agentPercentage':0x1}}]}},{'$unwind':'$storeInfo'},{'$match':{'$expr':{'$regexMatch':{'input':'$storeInfo.storeName','regex':search,'options':'i'}}}},{'$lookup':{'from':_0x503857(0x1aa),'localField':_0x503857(0x1ab),'foreignField':_0x503857(0x18d),'as':'storePaymentInfo'}},{'$unwind':{'path':_0x503857(0x1b4),'preserveNullAndEmptyArrays':!![]}},{'$group':{'_id':_0x503857(0x1c4),'pendingCommission':{'$sum':{'$cond':{'if':{'$ifNull':[_0x503857(0x1a6),![]]},'then':0x0,'else':_0x503857(0x1a7)}}},'agentCommission':{'$sum':{'$cond':{'if':{'$ifNull':[_0x503857(0x1a6),![]]},'then':0x0,'else':'$agentCommission'}}},'latestStorePaymentDate':{'$max':'$storePaymentInfo.date'},'storeData':{'$first':_0x503857(0x1cf)}}},(!!_0xf2da2b[_0x503857(0x1c1)][_0x503857(0x1d8)]||!!_0xf2da2b['query'][_0x503857(0x1e5)])&&{'$match':{'latestStorePaymentDate':{'$gte':_0x5023f1,'$lt':_0x7ec7a8}}},{'$sort':{..._0x150321,'_id':-0x1}},{'$facet':{'totalCommission':[{'$group':{'_id':null,'pendingCommission':{'$sum':{'$ifNull':[_0x503857(0x1df),0x0]}}}}],'documentCount':[{'$count':'total'}],'storeList':[{'$skip':(+page-0x1)*+limit},{'$limit':+limit}]}},{'$project':{'storeList':0x1,'documentCount':{'$arrayElemAt':[_0x503857(0x1f0),0x0]},'totalCommission':0x1}}],_0x511e16=await Commission[_0x503857(0x1d2)](_0x6843ed[_0x503857(0x1ae)](_0x3a1ad8=>!!_0x3a1ad8))[_0x503857(0x1cd)]({'locale':_0x503857(0x1b9),'numericOrdering':!![]});_0x4740e9[_0x503857(0x1a3)](0xc8)[_0x503857(0x1bb)]({'storeList':_0x511e16[0x0]?.[_0x503857(0x1d6)],'documentCount':_0x511e16[0x0]?.['documentCount']||0x0,'totalCommission':_0x511e16[0x0]?.[_0x503857(0x1b5)][0x0]||0x0,'page':parseInt(page),'limit':parseInt(limit),'order':asc===_0x503857(0x1b2)?_0x503857(0x1d0):_0x503857(0x199),'sortType':_0x541485||'pendingCommission'});}catch(_0x132b31){_0x7da21a(_0x132b31);}}),getAllAgentCommission=asyncHandler(async(_0x20ff4c,_0x5a1695,_0x22fd86)=>{const _0x14e659=_0x1c1b55;try{const {sortType:_0x327f9e,asc:asc='true',page:page=0x1,limit:limit=0xa,search:search=''}=_0x20ff4c['query'];let _0x5abd7d={};if(_0x327f9e)_0x5abd7d[_0x327f9e]=asc===_0x14e659(0x1b2)?0x1:-0x1,_0x327f9e!==_0x14e659(0x1ee)&&(_0x5abd7d={..._0x5abd7d,'pendingCommission':-0x1});else _0x5abd7d['pendingCommission']=-0x1;const _0x4d530d=_0x20ff4c['query']['startDate']?new Date(_0x20ff4c[_0x14e659(0x1c1)][_0x14e659(0x1d8)]+'T00:00:00.000Z'):new Date(_0x14e659(0x1a2)),_0x5a6e06=_0x20ff4c[_0x14e659(0x1c1)]['endDate']?new Date(_0x20ff4c[_0x14e659(0x1c1)][_0x14e659(0x1e5)]+_0x14e659(0x1bf)):new Date(),_0x2dfbee=[{'$lookup':{'from':_0x14e659(0x197),'localField':_0x14e659(0x192),'foreignField':'_id','as':_0x14e659(0x1ad)}},{'$unwind':{'path':'$agentPaymentInfo','preserveNullAndEmptyArrays':!![]}},{'$group':{'_id':'$agent','pendingCommission':{'$sum':{'$cond':{'if':{'$ifNull':[_0x14e659(0x1c5),![]]},'then':0x0,'else':_0x14e659(0x1ef)}}},'paidCommission':{'$sum':{'$cond':{'if':{'$ifNull':[_0x14e659(0x1c5),![]]},'then':_0x14e659(0x1ef),'else':0x0}}},'latestAgentPaymentDate':{'$max':_0x14e659(0x19c)}}},(!!_0x20ff4c[_0x14e659(0x1c1)][_0x14e659(0x1d8)]||!!_0x20ff4c[_0x14e659(0x1c1)]['endDate'])&&{'$match':{'$expr':{'$and':[{'$gte':['$latestAgentPaymentDate',_0x4d530d]},{'$lte':[_0x14e659(0x1c6),_0x5a6e06]}]}}},{'$lookup':{'from':'agents','foreignField':'_id','localField':_0x14e659(0x18d),'as':_0x14e659(0x18c),'pipeline':[{'$project':{'profilePic':0x1,'name':0x1,'deleteStatus':0x1,'agentUid':0x1,'phoneNumber':0x1}}]}},{'$unwind':{'path':'$agentInfo','preserveNullAndEmptyArrays':!![]}},{'$match':{'$expr':{'$regexMatch':{'input':_0x14e659(0x1d4),'regex':search,'options':'i'}}}},{'$sort':{..._0x5abd7d,'_id':-0x1}},{'$facet':{'totalCommission':[{'$group':{'_id':null,'pendingCommission':{'$sum':{'$ifNull':[_0x14e659(0x1df),0x0]}},'paidCommission':{'$sum':{'$ifNull':['$paidCommission',0x0]}}}}],'documentCount':[{'$count':_0x14e659(0x1e1)}],'storeList':[{'$skip':(+page-0x1)*+limit},{'$limit':+limit}]}},{'$project':{'storeList':0x1,'documentCount':{'$arrayElemAt':[_0x14e659(0x1f0),0x0]},'totalCommission':0x1}}],_0x5bb39c=await Commission[_0x14e659(0x1d2)](_0x2dfbee[_0x14e659(0x1ae)](_0xcd9ab7=>!!_0xcd9ab7))[_0x14e659(0x1cd)]({'locale':_0x14e659(0x1b9),'numericOrdering':!![]});_0x5a1695[_0x14e659(0x1a3)](0xc8)[_0x14e659(0x1bb)]({'storeList':_0x5bb39c[0x0]?.['storeList'],'documentCount':_0x5bb39c[0x0]?.[_0x14e659(0x1a0)]||0x0,'page':parseInt(page),'limit':parseInt(limit),'totalCommission':_0x5bb39c[0x0]?.[_0x14e659(0x1b5)][0x0]||0x0,'order':asc===_0x14e659(0x1b2)?_0x14e659(0x1d0):_0x14e659(0x199),'sortType':_0x327f9e||_0x14e659(0x1ee)});}catch(_0xd7e78){_0x22fd86(_0xd7e78);}}),getAgentCommissionAmount=asyncHandler(async(_0xe65e28,_0x2f34aa,_0x36278e)=>{const _0x1b3fc6=_0x1c1b55;try{const {id:_0x3cbfa5}=_0xe65e28[_0x1b3fc6(0x196)];(!mongoose['isValidObjectId'](_0x3cbfa5)||!await Agent[_0x1b3fc6(0x1be)]({'_id':_0x3cbfa5}))&&new MyCustomError(0x190,_0x1b3fc6(0x1c2));const _0x34b192=new mongoose[(_0x1b3fc6(0x1ec))][(_0x1b3fc6(0x1d3))](_0x3cbfa5),_0x43a4b0=_0xe65e28['query'][_0x1b3fc6(0x1d8)]?new Date(_0xe65e28[_0x1b3fc6(0x1c1)]['startDate']+'T00:00:00.000+05:30'):new Date(_0x1b3fc6(0x1a2)),_0x194572=_0xe65e28['query'][_0x1b3fc6(0x1e5)]?new Date(_0xe65e28[_0x1b3fc6(0x1c1)][_0x1b3fc6(0x1e5)]+_0x1b3fc6(0x1e3)):new Date(),_0x582e29=[{'$match':{'agent':_0x34b192,'storePayment':{'$exists':!![]},'agentPayment':{'$exists':![]},'createdAt':{'$gte':_0x43a4b0,'$lt':_0x194572}}},{'$group':{'_id':null,'amount':{'$sum':_0x1b3fc6(0x1ef)}}}],_0x1861e8=await Commission[_0x1b3fc6(0x1d2)](_0x582e29);_0x2f34aa['json']({'amount':_0x1861e8[0x0]?.[_0x1b3fc6(0x1d1)][_0x1b3fc6(0x1f2)](0x2)||0x0});}catch(_0x450559){_0x36278e(_0x450559);}}),payAgentCommission=asyncHandler(async(_0x106361,_0x28e62b,_0x5df083)=>{const _0x3b1263=_0x1c1b55,{id:_0x33edd8}=_0x106361[_0x3b1263(0x196)],{amount:_0x35cb5e,invoiceFrom:_0x19263b,invoiceTo:_0x5e8cee,date:_0x1d2ab8}=_0x106361['body'],_0x449121=await mongoose[_0x3b1263(0x1bc)]();try{_0x449121[_0x3b1263(0x1a8)]();if(!_0x19263b)return await _0x449121[_0x3b1263(0x18f)](),_0x5df083(new MyCustomError(0x190,'Please\x20Enter\x20Start\x20Date'));if(!_0x5e8cee)return await _0x449121[_0x3b1263(0x18f)](),_0x5df083(new MyCustomError(0x190,_0x3b1263(0x1ca)));if(!_0x1d2ab8)return await _0x449121[_0x3b1263(0x18f)](),_0x5df083(new MyCustomError(0x190,_0x3b1263(0x19e)));if(!mongoose['isValidObjectId'](_0x33edd8)||!await Agent[_0x3b1263(0x1be)]({'_id':_0x33edd8}))return await _0x449121['abortTransaction'](),_0x5df083(new MyCustomError(0x190,_0x3b1263(0x1c2)));const _0x10b421=new Date(_0x19263b+_0x3b1263(0x1e4)),_0x1301d5=new Date(_0x5e8cee+_0x3b1263(0x1e3)),_0x3f861b=new mongoose['Types']['ObjectId'](_0x33edd8),_0x45d424=[{'$match':{'agent':_0x3f861b,'storePayment':{'$exists':!![]},'agentPayment':{'$exists':![]},'createdAt':{'$gte':_0x10b421,'$lt':_0x1301d5}}},{'$group':{'_id':null,'amount':{'$sum':_0x3b1263(0x1ef)}}}],_0x19429c=await Commission[_0x3b1263(0x1d2)](_0x45d424);if(!_0x19429c[0x0]?.[_0x3b1263(0x1d1)])return await _0x449121[_0x3b1263(0x18f)](),_0x5df083(new MyCustomError(0x190,_0x3b1263(0x1eb)));const _0x5a457b=new AgentPayment({'agent':_0x33edd8,'amount':_0x19429c[0x0]?.[_0x3b1263(0x1d1)],'invoiceFrom':_0x19263b,'invoiceTo':_0x5e8cee,'date':_0x1d2ab8});await _0x5a457b['save']({'session':_0x449121});if(!_0x5a457b[_0x3b1263(0x1a4)])return await _0x449121[_0x3b1263(0x18f)](),_0x5df083(new MyCustomError(0x1f4,_0x3b1263(0x1ed)));const _0x252d6f=await Commission[_0x3b1263(0x1af)]({'agent':_0x3f861b,'storePayment':{'$exists':!![]},'agentPayment':{'$exists':![]},'createdAt':{'$gte':new Date(_0x10b421),'$lt':new Date(_0x1301d5)}},{'$set':{'agentPayment':_0x5a457b[_0x3b1263(0x18d)]}},{'session':_0x449121});await _0x449121[_0x3b1263(0x1b6)](),_0x28e62b[_0x3b1263(0x1a3)](0xc8)[_0x3b1263(0x1bb)]({'message':'Agent\x20Payment\x20Successfull','data':_0x252d6f,'payment':_0x5a457b});}catch(_0x376f57){await _0x449121[_0x3b1263(0x18f)](),_0x5df083(_0x376f57);}finally{await _0x449121[_0x3b1263(0x1a1)]();}}),payStoreCommission=asyncHandler(async(_0x28eff8,_0x139bee,_0x18241f)=>{const _0x2cb751=_0x1c1b55,{id:_0x233a4c}=_0x28eff8[_0x2cb751(0x196)],{amount:_0x164405,date:_0x29fb99}=_0x28eff8['body'],_0x135f5a=await mongoose[_0x2cb751(0x1bc)]();try{if(!_0x164405)return await _0x135f5a[_0x2cb751(0x18f)](),_0x18241f(new MyCustomError(0x193,_0x2cb751(0x193)));if(!_0x29fb99)return await _0x135f5a['abortTransaction'](),_0x18241f(new MyCustomError(0x193,_0x2cb751(0x19a)));_0x135f5a[_0x2cb751(0x1a8)]();if(!mongoose[_0x2cb751(0x1a9)](_0x233a4c))return await _0x135f5a[_0x2cb751(0x18f)](),_0x18241f(new MyCustomError(0x190,_0x2cb751(0x1e9)));const _0x457249=await Store[_0x2cb751(0x19b)](_0x233a4c),_0x4ce7ca=new mongoose['Types'][(_0x2cb751(0x1d3))](_0x233a4c);if(!_0x457249)return await _0x135f5a[_0x2cb751(0x18f)](),_0x18241f(new MyCustomError(0x190,'Problem\x20with\x20Finding\x20the\x20Store\x20Please\x20Contact\x20Support'));var _0x1ec238=+_0x164405+_0x457249[_0x2cb751(0x1c7)];const _0x43fb6d=await Commission['aggregate']([{'$match':{'store':_0x4ce7ca,'storePayment':{'$exists':![]}}},{'$addFields':{'adjustedCreatedAt':{'$subtract':[_0x2cb751(0x1c8),{'$multiply':[-0x14a*0x3c*0x3e8]}]}}},{'$group':{'_id':{'$dateToString':{'format':'%Y-%m-%d','date':_0x2cb751(0x1c3),'timezone':'UTC'}},'totalAmount':{'$sum':'$totalCommission'}}},{'$sort':{'_id':0x1}}]),_0x43164f=new StorePayment({'amount':_0x164405,'date':new Date(_0x29fb99),'store':_0x233a4c});await _0x43164f[_0x2cb751(0x1db)]({'session':_0x135f5a});if(!_0x43164f?.[_0x2cb751(0x1ac)])return await _0x135f5a['abortTransaction'](),_0x18241f(new MyCustomError(0x1f4,_0x2cb751(0x1f4)));const _0x36eec7=[];for(var _0x37ca25 of _0x43fb6d){if(_0x1ec238-_0x37ca25[_0x2cb751(0x1d9)]?.['toFixed'](0x2)>0x0)_0x36eec7['push']({'updateMany':{'filter':{'store':new mongoose['Types'][(_0x2cb751(0x1d3))](_0x233a4c),'createdAt':{'$gte':new Date(_0x37ca25[_0x2cb751(0x18d)]+_0x2cb751(0x1e4))[_0x2cb751(0x1e8)](),'$lt':new Date(_0x37ca25[_0x2cb751(0x18d)]+_0x2cb751(0x1e3))[_0x2cb751(0x1e8)]()}},'update':{'$set':{'storePayment':_0x43164f[_0x2cb751(0x18d)]}}}}),_0x1ec238-=_0x37ca25[_0x2cb751(0x1d9)];else break;}_0x457249[_0x2cb751(0x1c7)]=_0x1ec238,await Promise[_0x2cb751(0x18b)]([_0x457249[_0x2cb751(0x1db)]({'session':_0x135f5a}),_0x36eec7[_0x2cb751(0x1e7)]&&Commission['bulkWrite'](_0x36eec7,{'session':_0x135f5a})]),await _0x135f5a[_0x2cb751(0x1b6)](),_0x139bee['json']({'payment':_0x43164f});}catch(_0x291e39){await _0x135f5a['abortTransaction'](),_0x18241f(_0x291e39);}finally{await _0x135f5a[_0x2cb751(0x1a1)]();}}),getOneStoreCommission=asyncHandler(async(_0x534ddd,_0x44dfda,_0x29a15f)=>{const _0x4bf9ec=_0x1c1b55;try{const {id:_0xcb1c95}=_0x534ddd['params'];if(_0x534ddd[_0x4bf9ec(0x198)]['role']===_0x4bf9ec(0x1fa)&&_0xcb1c95!==_0x534ddd[_0x4bf9ec(0x198)][_0x4bf9ec(0x18d)][_0x4bf9ec(0x1f7)]())return _0x29a15f(new MyCustomError(0x193,_0x4bf9ec(0x1ea)));if(_0x534ddd[_0x4bf9ec(0x198)][_0x4bf9ec(0x1ba)]===_0x4bf9ec(0x1bd)&&(!mongoose[_0x4bf9ec(0x1a9)](_0xcb1c95)||!await Store[_0x4bf9ec(0x1be)]({'_id':_0xcb1c95})))return _0x29a15f(new MyCustomError(0x190,_0x4bf9ec(0x1d7)));const _0x5885bd=new mongoose[(_0x4bf9ec(0x1ec))]['ObjectId'](_0xcb1c95),{sortType:_0x840128,asc:asc='true',page:page=0x1,limit:limit=0xa}=_0x534ddd[_0x4bf9ec(0x1c1)],_0x213860={};_0x840128?_0x213860[_0x840128===_0x4bf9ec(0x1e6)?_0x4bf9ec(0x1ee):_0x840128]=asc===_0x4bf9ec(0x1b2)?0x1:-0x1:_0x213860[_0x4bf9ec(0x18d)]=-0x1;const _0x4a5241=_0x534ddd[_0x4bf9ec(0x1c1)][_0x4bf9ec(0x1d8)]?new Date(_0x534ddd[_0x4bf9ec(0x1c1)][_0x4bf9ec(0x1d8)]+_0x4bf9ec(0x1e4)):new Date(_0x4bf9ec(0x1a2)),_0x37e4ff=_0x534ddd[_0x4bf9ec(0x1c1)]['endDate']?new Date(_0x534ddd[_0x4bf9ec(0x1c1)][_0x4bf9ec(0x1e5)]+_0x4bf9ec(0x1e3)):new Date(),_0x543b0a=[{'$match':{'store':_0x5885bd,'createdAt':{'$gte':_0x4a5241,'$lt':_0x37e4ff}}},{'$lookup':{'from':'stores','localField':_0x4bf9ec(0x1fa),'foreignField':_0x4bf9ec(0x18d),'as':_0x4bf9ec(0x1cb)}},{'$unwind':_0x4bf9ec(0x1cf)},{'$addFields':{'adjustedCreatedAt':{'$subtract':['$createdAt',{'$multiply':[-0x14a*0x3c*0x3e8]}]}}},{'$group':{'_id':{'$dateToString':{'format':_0x4bf9ec(0x1f3),'date':_0x4bf9ec(0x1c3),'timezone':_0x4bf9ec(0x1a5)}},'pendingCommission':{'$sum':{'$cond':{'if':{'$ifNull':[_0x4bf9ec(0x1a6),![]]},'then':0x0,'else':'$totalCommission'}}},'commissions':{'$sum':_0x4bf9ec(0x1a7)}}},{'$sort':{..._0x213860}},{'$facet':{'documentCount':[{'$count':'total'}],'totalAmount':[{'$group':{'_id':null,'totalAmount':{'$sum':_0x4bf9ec(0x1df)}}}],'dateList':[{'$skip':(+page-0x1)*+limit},{'$limit':+limit}]}},{'$project':{'dateList':0x1,'documentCount':{'$arrayElemAt':['$documentCount.total',0x0]},'totalAmount':{'$arrayElemAt':['$totalAmount.totalAmount',0x0]}}}],_0x48faab=await Commission['aggregate'](_0x543b0a[_0x4bf9ec(0x1ae)](_0x1e50c0=>_0x1e50c0!==undefined))[_0x4bf9ec(0x1cd)]({'locale':'en_US','numericOrdering':!![]});_0x44dfda[_0x4bf9ec(0x1a3)](0xc8)['json']({'dateList':_0x48faab[0x0]?.['dateList'],'documentCount':_0x48faab[0x0]?.['documentCount']||0x0,'totalAmount':_0x48faab[0x0]?.['totalAmount']||0x0,'page':parseInt(page),'limit':parseInt(limit),'order':asc===_0x4bf9ec(0x1b2)?'asc':_0x4bf9ec(0x199),'sortType':_0x840128||_0x4bf9ec(0x18d)});}catch(_0xb1208f){_0x29a15f(_0xb1208f);}}),getOneAgentCommission=asyncHandler(async(_0x24e92a,_0x5d9b0f,_0x344a1b)=>{const _0x1f107e=_0x1c1b55;try{const {id:_0x45512c}=_0x24e92a[_0x1f107e(0x196)];if(_0x24e92a[_0x1f107e(0x198)][_0x1f107e(0x1ba)]===_0x1f107e(0x1b8)&&_0x45512c!==_0x24e92a[_0x1f107e(0x198)][_0x1f107e(0x18d)]['toString']())return _0x344a1b(new MyCustomError(0x193,_0x1f107e(0x19f)));if(!mongoose[_0x1f107e(0x1a9)](_0x45512c)||!await Agent[_0x1f107e(0x1be)]({'_id':_0x45512c}))return _0x344a1b(new MyCustomError(0x190,'Problem\x20with\x20finding\x20the\x20agent\x20please\x20contact\x20support'));const _0x55979f=new mongoose[(_0x1f107e(0x1ec))][(_0x1f107e(0x1d3))](_0x45512c),{sortType:_0xe43852,asc:asc='true',page:page=0x1,limit:limit=0xa}=_0x24e92a[_0x1f107e(0x1c1)],_0x58c19d={};_0xe43852?_0x58c19d[_0xe43852]=asc===_0x1f107e(0x1b2)?0x1:-0x1:_0x58c19d[_0x1f107e(0x18d)]=-0x1;const _0x147530=_0x24e92a[_0x1f107e(0x1c1)][_0x1f107e(0x1d8)]?new Date(_0x24e92a[_0x1f107e(0x1c1)][_0x1f107e(0x1d8)]+'T00:00:00.000+05:30'):new Date(_0x1f107e(0x1a2)),_0x7233b9=_0x24e92a[_0x1f107e(0x1c1)][_0x1f107e(0x1e5)]?new Date(_0x24e92a[_0x1f107e(0x1c1)][_0x1f107e(0x1e5)]+'T23:59:59.999+05:30'):new Date(),_0x3e0e8e=[{'$match':{'agent':_0x55979f,'createdAt':{'$gte':_0x147530,'$lt':_0x7233b9}}},{'$addFields':{'adjustedCreatedAt':{'$subtract':['$createdAt',{'$multiply':[-0x14a*0x3c*0x3e8]}]}}},{'$group':{'_id':{'$dateToString':{'format':_0x1f107e(0x1f3),'date':_0x1f107e(0x1c3),'timezone':_0x1f107e(0x1a5)}},'pendingCommission':{'$sum':{'$cond':{'if':{'$ifNull':['$agentPayment',![]]},'then':0x0,'else':_0x1f107e(0x1ef)}}},'storePending':{'$sum':{'$cond':{'if':{'$ifNull':[_0x1f107e(0x1a6),![]]},'then':0x0,'else':_0x1f107e(0x1ef)}}},'commissions':{'$sum':_0x1f107e(0x1ef)}}},{'$sort':{..._0x58c19d}},{'$facet':{'documentCount':[{'$count':_0x1f107e(0x1e1)}],'totalPending':[{'$group':{'_id':null,'totalPending':{'$sum':'$pendingCommission'}}}],'totalCommission':[{'$group':{'_id':null,'totalCommission':{'$sum':'$commissions'}}}],'dateList':[{'$skip':(+page-0x1)*+limit},{'$limit':+limit}]}},{'$project':{'dateList':0x1,'documentCount':{'$arrayElemAt':[_0x1f107e(0x1f0),0x0]},'totalPending':{'$arrayElemAt':['$totalPending.totalPending',0x0]},'totalCommission':{'$arrayElemAt':[_0x1f107e(0x191),0x0]}}}],_0x17fd06=await Commission[_0x1f107e(0x1d2)](_0x3e0e8e[_0x1f107e(0x1ae)](_0x2e3c56=>_0x2e3c56!==undefined))['collation']({'locale':'en_US','numericOrdering':!![]});_0x5d9b0f[_0x1f107e(0x1a3)](0xc8)['json']({'dateList':_0x17fd06[0x0]?.['dateList'],'totalPending':_0x17fd06[0x0]?.['totalPending']||0x0,'documentCount':_0x17fd06[0x0]?.[_0x1f107e(0x1a0)]||0x0,'totalCommission':_0x17fd06[0x0]?.[_0x1f107e(0x1b5)]||0x0,'page':parseInt(page),'limit':parseInt(limit),'order':asc==='true'?_0x1f107e(0x1d0):_0x1f107e(0x199),'sortType':_0xe43852||_0x1f107e(0x18d)});}catch(_0x53384f){_0x344a1b(_0x53384f);}}),getAgentPayment=asyncHandler(async(_0x448787,_0x1154ef,_0x14065b)=>{const _0x4afacf=_0x1c1b55;try{const {sortType:_0x412a54,asc:asc=_0x4afacf(0x1b2),page:page=0x1,limit:limit=0xa,search:search=''}=_0x448787[_0x4afacf(0x1c1)];let _0x1ca27e={};if(_0x412a54)_0x1ca27e[_0x412a54]=asc==='true'?0x1:-0x1,_0x412a54!==_0x4afacf(0x19d)&&(_0x1ca27e={..._0x1ca27e,'date':-0x1});else _0x1ca27e[_0x4afacf(0x19d)]=-0x1;const _0x320c59=_0x448787[_0x4afacf(0x1c1)][_0x4afacf(0x1d8)]?new Date(_0x448787[_0x4afacf(0x1c1)][_0x4afacf(0x1d8)]+_0x4afacf(0x1de)):new Date(_0x4afacf(0x1a2)),_0xce701c=_0x448787[_0x4afacf(0x1c1)][_0x4afacf(0x1e5)]?new Date(_0x448787[_0x4afacf(0x1c1)]['endDate']+_0x4afacf(0x1bf)):new Date(new Date()[_0x4afacf(0x195)]()+0x14a*0x3c*0x3e8),_0xbbf0da=[_0x448787[_0x4afacf(0x198)]['role']===_0x4afacf(0x1b8)&&{'$match':{'agent':_0x448787[_0x4afacf(0x198)][_0x4afacf(0x18d)]}},{'$match':{'date':{'$gte':_0x320c59,'$lt':_0xce701c}}},{'$lookup':{'from':'agents','foreignField':_0x4afacf(0x18d),'localField':_0x4afacf(0x1b8),'as':_0x4afacf(0x1b8),'pipeline':[{'$project':{'profilePic':0x1,'name':0x1,'deleteStatus':0x1,'agentUid':0x1,'phoneNumber':0x1}}]}},{'$unwind':{'path':'$agent','preserveNullAndEmptyArrays':!![]}},{'$match':{'$expr':{'$regexMatch':{'input':_0x4afacf(0x1f9),'regex':search,'options':'i'}}}},{'$sort':{..._0x1ca27e,'_id':-0x1}},{'$facet':{'documentCount':[{'$count':_0x4afacf(0x1e1)}],'paymentList':[{'$skip':(+page-0x1)*+limit},{'$limit':+limit}]}},{'$project':{'paymentList':0x1,'documentCount':{'$arrayElemAt':[_0x4afacf(0x1f0),0x0]}}}],_0x4d394f=await AgentPayment[_0x4afacf(0x1d2)](_0xbbf0da[_0x4afacf(0x1ae)](_0x16fd01=>!!_0x16fd01))[_0x4afacf(0x1cd)]({'locale':'en_US','numericOrdering':!![]});_0x1154ef[_0x4afacf(0x1a3)](0xc8)['json']({'paymentList':_0x4d394f[0x0]?.[_0x4afacf(0x1e0)],'documentCount':_0x4d394f[0x0]?.['documentCount']||0x0,'page':parseInt(page),'limit':parseInt(limit),'order':asc==='true'?'asc':'desc','sortType':_0x412a54||_0x4afacf(0x19d)});}catch(_0x24e7da){_0x14065b(_0x24e7da);}}),getStorePayment=asyncHandler(async(_0x50edee,_0x6caa72,_0x20f575)=>{const _0x4d5061=_0x1c1b55;try{const {sortType:_0x1971a7,asc:asc=_0x4d5061(0x1b2),page:page=0x1,limit:limit=0xa,search:search=''}=_0x50edee['query'];let _0x422db0={};if(_0x1971a7)_0x422db0[_0x1971a7]=asc===_0x4d5061(0x1b2)?0x1:-0x1,_0x1971a7!=='storePaymentUid'&&(_0x422db0={..._0x422db0,'pendingCommission':-0x1});else _0x422db0[_0x4d5061(0x1ac)]=-0x1;const _0x9e3fc=_0x50edee[_0x4d5061(0x1c1)][_0x4d5061(0x1d8)]?new Date(_0x50edee[_0x4d5061(0x1c1)][_0x4d5061(0x1d8)]+_0x4d5061(0x1de)):new Date('1970-01-01'),_0x50b11b=_0x50edee[_0x4d5061(0x1c1)][_0x4d5061(0x1e5)]?new Date(_0x50edee[_0x4d5061(0x1c1)][_0x4d5061(0x1e5)]+_0x4d5061(0x1bf)):new Date(new Date()[_0x4d5061(0x195)]()+0x14a*0x3c*0x3e8),_0x95c635=[_0x50edee[_0x4d5061(0x198)]['role']===_0x4d5061(0x1bd)?{'$match':{'date':{'$gte':_0x9e3fc,'$lt':_0x50b11b}}}:{'$match':{'store':_0x50edee[_0x4d5061(0x198)][_0x4d5061(0x18d)],'date':{'$gte':_0x9e3fc,'$lt':_0x50b11b}}},,_0x50edee[_0x4d5061(0x198)][_0x4d5061(0x1ba)]===_0x4d5061(0x1bd)&&{'$lookup':{'from':_0x4d5061(0x1e2),'foreignField':_0x4d5061(0x18d),'localField':_0x4d5061(0x1fa),'as':_0x4d5061(0x1fa),'pipeline':[{'$project':{'profilePic':0x1,'storeName':0x1,'deleteStatus':0x1,'storeUid':0x1,'phoneNumber':0x1}}]}},_0x50edee[_0x4d5061(0x198)]['role']===_0x4d5061(0x1bd)&&{'$unwind':{'path':_0x4d5061(0x1c4),'preserveNullAndEmptyArrays':!![]}},_0x50edee[_0x4d5061(0x198)][_0x4d5061(0x1ba)]===_0x4d5061(0x1bd)&&{'$match':{'$expr':{'$regexMatch':{'input':_0x4d5061(0x1b3),'regex':search,'options':'i'}}}},{'$sort':{..._0x422db0,'_id':-0x1}},{'$facet':{'documentCount':[{'$count':_0x4d5061(0x1e1)}],'paymentList':[{'$skip':(+page-0x1)*+limit},{'$limit':+limit}]}},{'$project':{'paymentList':0x1,'documentCount':{'$arrayElemAt':[_0x4d5061(0x1f0),0x0]}}}],_0x41f4a8=await StorePayment[_0x4d5061(0x1d2)](_0x95c635[_0x4d5061(0x1ae)](_0x43fd70=>!!_0x43fd70))['collation']({'locale':_0x4d5061(0x1b9),'numericOrdering':!![]});_0x6caa72['status'](0xc8)[_0x4d5061(0x1bb)]({'paymentList':_0x41f4a8[0x0]?.['paymentList'],'documentCount':_0x41f4a8[0x0]?.[_0x4d5061(0x1a0)]||0x0,'page':parseInt(page),'limit':parseInt(limit),'order':asc===_0x4d5061(0x1b2)?_0x4d5061(0x1d0):_0x4d5061(0x199),'sortType':_0x1971a7||_0x4d5061(0x1ac)});}catch(_0x1974d4){_0x20f575(_0x1974d4);}});module[_0x1c1b55(0x1f1)]={'createCommission':createCommission,'getAllStoreCommission':getAllStoreCommission,'getAllAgentCommission':getAllAgentCommission,'getAgentCommissionAmount':getAgentCommissionAmount,'payStoreCommission':payStoreCommission,'payAgentCommission':payAgentCommission,'getOneStoreCommission':getOneStoreCommission,'getOneAgentCommission':getOneAgentCommission,'getAgentPayment':getAgentPayment,'getStorePayment':getStorePayment};