const _0xb51cf5=_0x48af;function _0x48af(_0x3a521e,_0x14e515){const _0x130359=_0x1303();return _0x48af=function(_0x48af52,_0x1f26bc){_0x48af52=_0x48af52-0x99;let _0xf35d75=_0x130359[_0x48af52];return _0xf35d75;},_0x48af(_0x3a521e,_0x14e515);}(function(_0x2152ca,_0x10619f){const _0xbbc96b=_0x48af,_0x9141f8=_0x2152ca();while(!![]){try{const _0x3e530c=parseInt(_0xbbc96b(0xe1))/0x1*(parseInt(_0xbbc96b(0xad))/0x2)+-parseInt(_0xbbc96b(0xc9))/0x3*(parseInt(_0xbbc96b(0xdc))/0x4)+parseInt(_0xbbc96b(0xa5))/0x5+parseInt(_0xbbc96b(0xda))/0x6*(-parseInt(_0xbbc96b(0xc3))/0x7)+parseInt(_0xbbc96b(0xb8))/0x8+-parseInt(_0xbbc96b(0xa6))/0x9*(parseInt(_0xbbc96b(0xd6))/0xa)+parseInt(_0xbbc96b(0x9d))/0xb;if(_0x3e530c===_0x10619f)break;else _0x9141f8['push'](_0x9141f8['shift']());}catch(_0x5447c3){_0x9141f8['push'](_0x9141f8['shift']());}}}(_0x1303,0x81def));function _0x1303(){const _0x596ae2=['T23:59:59.999+05:30','after','\x20is\x20OTP\x20for\x20your\x20Lifestores\x20login.\x20OTP\x20valid\x20for\x2010\x20minutes.\x20Do\x20not\x20share\x20this\x20OTP\x20with\x20anyone.','save','abortTransaction','jsonwebtoken','agent','url','pan','Customer(s)\x20provided\x20is\x20invalid','gender','$$endDate','Please\x20provide\x20phone\x20number','login','10275749YqkdfQ','startDate','false','Access\x20denied.\x20Insufficient\x20permissions.','$createdAt','env','_id','findByIdAndUpdate','1377755XaQUqT','4061547WJnahF','desc','customer','$$startDate','email','total','sign','223174XjdDBl','Customer\x20created\x20successfully','asc','collation','../models/customer.model','profilePic','phoneNumber','push','dob','generateSecret','Customer\x20not\x20found.','4949488lEgRkV','JWT_SECRET_KEY','aggregate','then','user','filter','commitTransaction','commissions','json','+91','aadhar','42DGwMhp','exports','base32','Customer(s)\x20is\x20not\x20Present','Invalid\x20or\x20Expried\x20OTP','../aws/sns','49953IfeRos','role','length','isValidObjectId','startTransaction','address','customerUid','en_US','toString','forEach','Agent\x20Doesnot\x20Exists','all','OTP\x20sent\x20successfully.','20sZArMx','../helper/otpVerification','params','size','285774DauEJm','File\x20Too\x20Large','160kNSCRj','endDate','Invalid\x20agent','admin','status','5WIKCdJ','../middlewares/error/error.handler','1970-01-01','$agent','express-async-handler','findById','key','startSession','name','agents','../aws/s3','\x20Customer(s)\x20Restored\x20successfully','map','body','Error\x20while\x20creating\x20Customer','true','endSession','_id\x20name','query','OTP\x20Expried'];_0x1303=function(){return _0x596ae2;};return _0x1303();}const asyncHandler=require(_0xb51cf5(0xe5)),mongoose=require('mongoose'),Customer=require(_0xb51cf5(0xb1)),Agent=require('../models/agent.model'),jwt=require(_0xb51cf5(0xfa)),{sendMessage}=require(_0xb51cf5(0xc8)),speakeasy=require('speakeasy'),{uploadToS3,updateS3Object,getPresignedUrl}=require(_0xb51cf5(0xeb)),{MyCustomError}=require(_0xb51cf5(0xe2)),{verifyOtp}=require(_0xb51cf5(0xd7)),createCustomer=asyncHandler(async(_0x5b6b90,_0xf3f728,_0x1d12a5)=>{const _0x31d22a=_0xb51cf5,_0x5e39a2=await mongoose[_0x31d22a(0xe8)]();try{_0x5e39a2['startTransaction']();const {name:_0xb352c7,phoneNumber:_0x27f31a,address:_0xda8db8,email:_0x38ce25,gender:_0xbf0c08,dob:_0x260338,pan:_0x139241,aadhar:_0x455d74,password:_0x21e7bb,agent:_0x111e29,anniversary:_0x3cbac6,secret:_0x5daf26,otp:_0x5cbbd9}=_0x5b6b90[_0x31d22a(0xee)],{valid:_0x46fabf,verified:_0x15ee4d}=verifyOtp(_0x5daf26,_0x5cbbd9);if(!_0x15ee4d||!_0x46fabf){if(!_0x46fabf)return _0x1d12a5(new MyCustomError(0x190,_0x31d22a(0xc7)));return _0x1d12a5(new MyCustomError(0x190,_0x31d22a(0xf4)));}if(!mongoose[_0x31d22a(0xcc)](_0x111e29))return await _0x5e39a2[_0x31d22a(0xf9)](),_0x1d12a5(new MyCustomError(0x190,_0x31d22a(0xde)));const _0x430d5e=await Agent[_0x31d22a(0xe6)](_0x111e29);if(!_0x430d5e)return await _0x5e39a2['abortTransaction'](),_0x1d12a5(new MyCustomError(0x190,_0x31d22a(0xd3)));const _0x22bb21=new Customer({'name':_0xb352c7,'phoneNumber':_0x27f31a,'address':_0xda8db8,'email':_0x38ce25,'gender':_0xbf0c08,'dob':_0x260338,'pan':_0x139241,'aadhar':_0x455d74,'password':_0x21e7bb,'agent':_0x111e29,'anniversary':_0x3cbac6});await _0x22bb21[_0x31d22a(0xf8)]({'session':_0x5e39a2})['then'](async _0x97565c=>{const _0xb1f1bf=_0x31d22a;if(!_0x97565c[_0xb1f1bf(0xcf)])return await _0x5e39a2[_0xb1f1bf(0xf9)](),_0x1d12a5(new MyCustomError(0x1f4,_0xb1f1bf(0xef)));const _0x27b913=_0x5b6b90['files'],_0x43b537={};_0x27b913?.[_0xb1f1bf(0xd2)](_0x186a03=>{const _0x28bc65=_0xb1f1bf,{fieldname:_0x32e583}=_0x186a03;!_0x43b537[_0x32e583]&&(_0x43b537[_0x32e583]=[]),_0x43b537[_0x32e583][_0x28bc65(0xb4)](_0x186a03);});if(_0x43b537?.['profilePic']?.[_0xb1f1bf(0xcb)]>0x0){if(_0x43b537[_0xb1f1bf(0xb2)][0x0][_0xb1f1bf(0xd9)]>0x400*0x400*0x2)return await _0x5e39a2[_0xb1f1bf(0xf9)](),_0x1d12a5(new MyCustomError(0x19d,_0xb1f1bf(0xdb)));_0x22bb21[_0xb1f1bf(0xb2)]=await uploadToS3({'file':_0x43b537['profilePic'][0x0],'uid':_0x97565c['customerUid'],'user':_0xb1f1bf(0xa8),'type':_0xb1f1bf(0xb2)}),await _0x22bb21[_0xb1f1bf(0xf8)]({'session':_0x5e39a2});}await _0x5e39a2[_0xb1f1bf(0xbe)](),_0xf3f728[_0xb1f1bf(0xe0)](0xc9)[_0xb1f1bf(0xc0)]({'message':_0xb1f1bf(0xae),'customer':_0x22bb21});});}catch(_0x4a0954){await _0x5e39a2['abortTransaction'](),_0x1d12a5(_0x4a0954);}finally{_0x5e39a2[_0x31d22a(0xf1)]();}}),customerLogin=asyncHandler(async(_0x4ea8ec,_0x3d0787,_0x436c08)=>{const _0x5948d3=_0xb51cf5;try{const {emailOrPhoneNumber:_0x323453,password:_0x640b80}=_0x4ea8ec[_0x5948d3(0xee)],_0x28d015=await Customer[_0x5948d3(0x9c)](_0x323453,_0x640b80),_0x183715=jwt[_0x5948d3(0xac)]({'id':_0x28d015['_id'],'email':_0x28d015['email'],'phoneNumber':_0x28d015[_0x5948d3(0xb3)],'role':_0x5948d3(0xa8)},process[_0x5948d3(0xa2)][_0x5948d3(0xb9)],{'expiresIn':'1h'});_0x3d0787['status'](0xc8)[_0x5948d3(0xc0)]({'customer':_0x28d015,'token':_0x183715});}catch(_0x4afac4){_0x436c08(_0x4afac4);}}),getCustomerList=asyncHandler(async(_0x4c1927,_0x3e737a,_0x1a8e81)=>{const _0x236d57=_0xb51cf5;try{const {sortType:_0x380e67,asc:asc=_0x236d57(0xf0),page:page=0x1,limit:limit=0xa,search:search='',agentName:agentName='',deleteStatus:deleteStatus='false'}=_0x4c1927[_0x236d57(0xf3)],_0x21e4c0={};if(_0x380e67)_0x21e4c0[_0x380e67]=asc===_0x236d57(0xf0)?0x1:-0x1;const _0x15f66a=_0x4c1927[_0x236d57(0xf3)][_0x236d57(0x9e)]?new Date(_0x4c1927[_0x236d57(0xf3)][_0x236d57(0x9e)]+'T00:00:00.000+05:30'):new Date(_0x236d57(0xe3)),_0x1b1981=_0x4c1927[_0x236d57(0xf3)]['endDate']?new Date(_0x4c1927[_0x236d57(0xf3)][_0x236d57(0xdd)]+_0x236d57(0xf5)):new Date(),_0x2759c6=[_0x4c1927[_0x236d57(0xbc)][_0x236d57(0xca)]===_0x236d57(0xfb)&&{'$match':{'agent':_0x4c1927[_0x236d57(0xbc)][_0x236d57(0xa3)]}},{'$lookup':{'from':_0x236d57(0xea),'localField':_0x236d57(0xfb),'foreignField':_0x236d57(0xa3),'as':_0x236d57(0xfb),'pipeline':[{'$project':{'name':0x1,'phoneNumber':0x1}}]}},{'$unwind':_0x236d57(0xe4)},{'$match':{'$and':[{'$or':[{'name':{'$regex':search,'$options':'i'}},{'phoneNumber':{'$regex':search,'$options':'i'}}]},{'deleteStatus':deleteStatus},{'$or':[{'agent.name':{'$regex':agentName,'$options':'i'}},{'agent.phoneNumber':{'$regex':agentName,'$options':'i'}}]}]}},{'$lookup':{'from':'commissions','localField':'_id','foreignField':_0x236d57(0xa8),'as':_0x236d57(0xbf),'let':{'startDate':_0x15f66a,'endDate':_0x1b1981},'pipeline':[{'$match':{'$expr':{'$and':[{'$gte':['$createdAt',_0x236d57(0xa9)]},{'$lte':[_0x236d57(0xa1),_0x236d57(0x9a)]}]}}}]}},{'$addFields':{'totalSpending':{'$sum':{'$ifNull':['$commissions.amount',0x0]}}}},{'$project':{'commissions':0x0}},{'$sort':{..._0x21e4c0,'customerUid':-0x1}},{'$facet':{'documentCount':[{'$count':_0x236d57(0xab)}],'customerList':[{'$skip':(+page-0x1)*+limit},{'$limit':+limit}]}},{'$project':{'customerList':0x1,'documentCount':{'$arrayElemAt':['$documentCount.total',0x0]}}}];await Customer[_0x236d57(0xba)](_0x2759c6[_0x236d57(0xbd)](_0x27fa07=>!!_0x27fa07))[_0x236d57(0xb0)]({'locale':_0x236d57(0xd0),'numericOrdering':!![]})[_0x236d57(0xbb)](_0x192140=>{const _0x1263ee=_0x236d57;_0x3e737a['status'](0xc8)[_0x1263ee(0xc0)]({'customerList':_0x192140[0x0]?.['customerList'],'documentCount':_0x192140[0x0]?.['documentCount']||0x0,'page':+page,'limit':+limit,'order':asc===_0x1263ee(0xf0)?_0x1263ee(0xaf):_0x1263ee(0xa7),'sortType':_0x380e67||_0x1263ee(0xcf)});});}catch(_0x5ba50b){_0x1a8e81(_0x5ba50b);}}),getOneCustomer=asyncHandler(async(_0x4a2c85,_0x1b278a,_0x3e417d)=>{const _0x1ea982=_0xb51cf5,{id:_0x6489b1}=_0x4a2c85[_0x1ea982(0xd8)];if(_0x4a2c85['user']['role']===_0x1ea982(0xa8)&&_0x4a2c85['user'][_0x1ea982(0xa3)]!==_0x6489b1)return _0x3e417d(new MyCustomError(0x193,_0x1ea982(0xa0)));try{await Customer[_0x1ea982(0xe6)](_0x6489b1)[_0x1ea982(0xbb)](async _0x1689dd=>{const _0x57ccc9=_0x1ea982;if(!_0x1689dd)return _0x3e417d(new MyCustomError(0x194,_0x57ccc9(0xb7)));if(_0x4a2c85['user'][_0x57ccc9(0xca)]===_0x57ccc9(0xfb)&&_0x1689dd[_0x57ccc9(0xfb)][_0x57ccc9(0xd1)]()!==_0x4a2c85[_0x57ccc9(0xbc)]['_id'][_0x57ccc9(0xd1)]())return _0x3e417d(new MyCustomError(0x193,_0x57ccc9(0xa0)));if(_0x1689dd[_0x57ccc9(0xb2)]){const _0x3f1d70=await getPresignedUrl(_0x1689dd['profilePic']['key']);_0x1689dd['profilePic'][_0x57ccc9(0xfc)]=_0x3f1d70;}_0x1b278a[_0x57ccc9(0xe0)](0xc8)[_0x57ccc9(0xc0)]({'customer':_0x1689dd});});}catch(_0x105e3a){_0x3e417d(_0x105e3a);}}),updateCustomer=asyncHandler(async(_0x11b2e3,_0x3b33d4,_0x304155)=>{const _0x569c93=_0xb51cf5,{id:_0x3ef0b2}=_0x11b2e3[_0x569c93(0xd8)];if(_0x11b2e3[_0x569c93(0xbc)][_0x569c93(0xca)]!==_0x569c93(0xdf)&&_0x11b2e3['user']['role']!==_0x569c93(0xa8)||_0x11b2e3[_0x569c93(0xbc)][_0x569c93(0xca)]===_0x569c93(0xa8)&&_0x11b2e3[_0x569c93(0xbc)][_0x569c93(0xa3)]!==_0x3ef0b2)return _0x304155(new MyCustomError(0x193,'Access\x20denied.\x20Insufficient\x20permissions.'));const _0x2daba8=await mongoose[_0x569c93(0xe8)]();try{const _0x5cb1fb=await Customer['findById'](_0x3ef0b2);if(!_0x5cb1fb)return _0x304155(new MyCustomError(0x194,_0x569c93(0xb7)));_0x11b2e3[_0x569c93(0xee)]['name']&&(_0x5cb1fb[_0x569c93(0xe9)]=_0x11b2e3[_0x569c93(0xee)][_0x569c93(0xe9)]);_0x11b2e3[_0x569c93(0xee)]['phoneNumber']&&(_0x5cb1fb[_0x569c93(0xb3)]=_0x11b2e3[_0x569c93(0xee)]['phoneNumber']);_0x11b2e3[_0x569c93(0xee)][_0x569c93(0xce)]&&(_0x5cb1fb[_0x569c93(0xce)]=_0x11b2e3['body'][_0x569c93(0xce)]);_0x11b2e3[_0x569c93(0xee)][_0x569c93(0xaa)]&&(_0x5cb1fb['email']=_0x11b2e3['body']['email']);_0x11b2e3['body'][_0x569c93(0x99)]&&(_0x5cb1fb[_0x569c93(0x99)]=_0x11b2e3[_0x569c93(0xee)]['gender']);_0x11b2e3['body'][_0x569c93(0xb5)]&&(_0x5cb1fb[_0x569c93(0xb5)]=_0x11b2e3['body'][_0x569c93(0xb5)]);_0x11b2e3[_0x569c93(0xee)][_0x569c93(0xfd)]&&(_0x5cb1fb[_0x569c93(0xfd)]=_0x11b2e3[_0x569c93(0xee)]['pan']);_0x11b2e3[_0x569c93(0xee)]['aadhar']&&(_0x5cb1fb[_0x569c93(0xc2)]=_0x11b2e3[_0x569c93(0xee)]['aadhar']);_0x11b2e3['body']['agent']&&(_0x5cb1fb[_0x569c93(0xfb)]=_0x11b2e3[_0x569c93(0xee)][_0x569c93(0xfb)]);_0x11b2e3[_0x569c93(0xee)]['anniversary']&&(_0x5cb1fb['anniversary']=_0x11b2e3[_0x569c93(0xee)]['anniversary']);const _0x5b95b3=_0x11b2e3['files'],_0xb85f2b={};_0x5b95b3?.[_0x569c93(0xd2)](_0x10963d=>{const {fieldname:_0x5833dc}=_0x10963d;!_0xb85f2b[_0x5833dc]&&(_0xb85f2b[_0x5833dc]=[]),_0xb85f2b[_0x5833dc]['push'](_0x10963d);});if(_0xb85f2b?.[_0x569c93(0xb2)]?.[_0x569c93(0xcb)]>0x0){if(_0xb85f2b[_0x569c93(0xb2)][0x0][_0x569c93(0xd9)]>0x400*0x400*0x2)return _0x304155(new MyCustomError(0x19d,_0x569c93(0xdb)));_0x5cb1fb[_0x569c93(0xb2)]?_0x5cb1fb[_0x569c93(0xb2)]=await updateS3Object(_0xb85f2b['profilePic'][0x0],_0x5cb1fb['profilePic'][_0x569c93(0xe7)]):_0x5cb1fb[_0x569c93(0xb2)]=await uploadToS3({'file':_0xb85f2b['profilePic'][0x0],'uid':_0x5cb1fb[_0x569c93(0xcf)],'user':'customer','type':_0x569c93(0xb2)});}await _0x5cb1fb[_0x569c93(0xf8)](),_0x3b33d4[_0x569c93(0xc0)]({'message':'Customer\x20updated\x20successfully','customer':_0x5cb1fb});}catch(_0x23b607){_0x304155(_0x23b607);}finally{_0x2daba8[_0x569c93(0xf1)]();}}),deleteManyCustomer=asyncHandler(async(_0x2454ff,_0x2615d5,_0x2a30d1)=>{const _0x34829a=_0xb51cf5,{idArray:_0x34967d}=_0x2454ff[_0x34829a(0xee)],_0x1340a7=await mongoose['startSession']();try{_0x1340a7[_0x34829a(0xcd)]();const _0x15d4f4=await Promise['all'](_0x34967d[_0x34829a(0xed)](async _0x21c5bc=>{const _0x5483c9=_0x34829a;if(!mongoose[_0x5483c9(0xcc)](_0x21c5bc))throw new MyCustomError(0x190,_0x5483c9(0xfe));const _0x5a53c6=await Customer[_0x5483c9(0xa4)](_0x21c5bc,{'deleteStatus':'true'},{'returnDocument':_0x5483c9(0xf6),'select':_0x5483c9(0xf2)});if(!_0x5a53c6)throw new MyCustomError(0x190,_0x5483c9(0xc6));return _0x5a53c6;}));_0x2615d5[_0x34829a(0xc0)]({'message':_0x34967d['length']+'\x20Customer(s)\x20Deleted\x20successfully','result':_0x15d4f4});}catch(_0x9c1ca9){await _0x1340a7[_0x34829a(0xf9)](),_0x2a30d1(_0x9c1ca9);}finally{_0x1340a7['endSession']();}}),restoreManyCustomer=asyncHandler(async(_0x4f7850,_0x5c5081,_0x61a615)=>{const _0x588da5=_0xb51cf5,{idArray:_0x51255c}=_0x4f7850[_0x588da5(0xee)],_0x131438=await mongoose[_0x588da5(0xe8)]();try{_0x131438[_0x588da5(0xcd)]();const _0x52cabb=await Promise[_0x588da5(0xd4)](_0x51255c[_0x588da5(0xed)](async _0x14f8f2=>{const _0x4150e7=_0x588da5;if(!mongoose[_0x4150e7(0xcc)](_0x14f8f2))throw new MyCustomError(0x190,'Customer(s)\x20provided\x20is\x20invalid');const _0x1cd883=await Customer[_0x4150e7(0xa4)](_0x14f8f2,{'deleteStatus':_0x4150e7(0x9f)},{'returnDocument':_0x4150e7(0xf6),'select':_0x4150e7(0xf2)});if(!_0x1cd883)throw new MyCustomError(0x190,_0x4150e7(0xfe));return _0x1cd883;}));_0x5c5081[_0x588da5(0xc0)]({'message':_0x51255c[_0x588da5(0xcb)]+_0x588da5(0xec),'result':_0x52cabb});}catch(_0x157ee7){await _0x131438[_0x588da5(0xf9)](),_0x61a615(_0x157ee7);}finally{_0x131438[_0x588da5(0xf1)]();}}),sendOtp=asyncHandler(async(_0x2f44ba,_0x13945e,_0x44c324)=>{const _0x28a4cc=_0xb51cf5,{phoneNumber:_0x5a8a3b}=_0x2f44ba['body'],_0x4dcc7c=speakeasy[_0x28a4cc(0xb6)]({'length':0x14}),_0x24f76a=speakeasy['totp']({'secret':_0x4dcc7c[_0x28a4cc(0xc5)],'encoding':_0x28a4cc(0xc5)}),_0x2a2247=_0x24f76a+_0x28a4cc(0xf7);try{!_0x5a8a3b&&_0x44c324(new MyCustomError(0x190,_0x28a4cc(0x9b))),await sendMessage(_0x2a2247,_0x28a4cc(0xc1)+_0x5a8a3b),_0x13945e[_0x28a4cc(0xc0)]({'message':_0x28a4cc(0xd5),'secret':_0x4dcc7c[_0x28a4cc(0xc5)]});}catch(_0x2283bb){_0x44c324(_0x2283bb);}});module[_0xb51cf5(0xc4)]={'createCustomer':createCustomer,'customerLogin':customerLogin,'getCustomerList':getCustomerList,'getOneCustomer':getOneCustomer,'updateCustomer':updateCustomer,'sendOtp':sendOtp,'deleteManyCustomer':deleteManyCustomer,'restoreManyCustomer':restoreManyCustomer};